# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id: Portfile 138305 2015-07-05 10:11:23Z takeshi@macports.org $

PortSystem          1.0
PortGroup cmake     1.0
PortGroup compilers 1.0

name                grib_api
version             1.13.1
revision            3
platforms           darwin
maintainers         takeshi
license             Apache-2
categories          science
description         GRIB decoder
homepage            https://software.ecmwf.int/wiki/display/GRIB/Home
master_sites        https://software.ecmwf.int/wiki/download/attachments/3473437
checksums           sha1    5cc9ef0318a36d7461038575f67d5385426e5d14 \
                    rmd160  9cb2e4cdb9651d637f15eb061310648286535ebf
long_description \
    The ECMWF GRIB API is an application program interface accessible \
    from C and FORTRAN programs developed for encoding and decoding   \
    WMO FM-92 GRIB edition 1 and edition 2 messages. A useful set of  \
    command line tools is also provided to give quick access to grib messages.

if [fortran_variant_isset] {
    compilers.choose    fc f77 f90
}
compilers.setup     -clang -dragonegg -gfortran -llvm

depends_build-append \
                    bin:bison:bison \
                    bin:flex:flex \
                    port:perl5
depends_lib         port:jasper \
                    port:hdf5 \
                    port:openjpeg \
                    port:libpng \
                    port:netcdf \
                    port:zlib

fetch.ignore_sslcert yes
cmake.out_of_source yes

if {![fortran_variant_isset]} {
    default_variants    +gcc5
}

configure.args-append \
                    -DENABLE_FORTRAN=OFF \
                    -DENABLE_NETCDF=ON \
                    -DENABLE_PNG=ON \
                    -DENABLE_PYTHON=OFF \
                    -DENABLE_TESTS=OFF \
                    -DJASPER_INCLUDE_DIR=${prefix}/include \
                    -DJASPER_LIBRARY_RELEASE=${prefix}/lib/libjasper.dylib \
                    -DHDF5_z_LIBRARY_RELEASE=${prefix}/lib/libz.dylib \
                    -DNETCDF_CONFIG_EXECUTABLE=${prefix}/bin/nc-config \
                    -DOPENJPEG_INCLUDE_DIR=${prefix}/include/openjpeg-2.1 \
                    -DOPENJPEG_LIBRARY=${prefix}/lib/libopenjp2.dylib \
                    -DPERL_EXECUTABLE=${prefix}/bin/perl \
                    -DZLIB_INCLUDE_DIR=${prefix}/include \
                    -DZLIB_LIBRARY=${prefix}/lib/libz.dylib

post-destroot {
    xinstall -m 755 -d ${destroot}${prefix}/share/doc/${name}
    eval xinstall -m 644 [glob ${worksrcpath}/html/*.html] \
        ${destroot}${prefix}/share/doc/${name}
    file rename ${destroot}${prefix}/bin/parser ${destroot}${prefix}/bin/grib_parser
    foreach c {grib_api-targets.cmake grib_api-targets-release.cmake} {
        reinplace "s|parser|grib_parser|g" ${destroot}${prefix}/share/${name}/cmake/${c}
    }
}

variant emos description {deprecated to remove dependency to emos} {
}
 
if {[fortran_variant_isset]} {
    configure.args-delete   -DENABLE_FORTRAN=OFF
    configure.args-append   -DENABLE_FORTRAN=ON
}

# TODO: Remove after 2016-01-04.
variant python25 requires python27 description {Legacy variant} {}
variant python26 requires python27 description {Legacy variant} {}

variant python27 description {Add support for python27} {
    depends_lib-append      port:py27-numpy
    configure.args-delete   -DENABLE_PYTHON=OFF
    configure.args-append   -DENABLE_PYTHON=ON \
                            -DPYTHON_CONFIG=${prefix}/bin/python2.7-config \
                            -DPYTHON_EXECUTABLE=${prefix}/bin/python2.7 \
}

livecheck.type	regex
livecheck.url	${homepage}
livecheck.regex "GRIB API version (\\d+(?:\\.\\d+)*)"
