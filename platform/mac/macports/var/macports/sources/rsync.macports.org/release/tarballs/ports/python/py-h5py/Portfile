# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id: Portfile 142558 2015-11-15 17:24:00Z mmoll@macports.org $

PortSystem          1.0
PortGroup           python 1.0
PortGroup           mpi 1.0

name                py-h5py
version             2.5.0
revision            2
# h5py needs to be re-built after hdf5 upgrades

platforms           darwin
license             BSD
maintainers         eborisch openmaintainer

description         Read and write HDF5 files from Python

long_description  \
    The h5py package provides both a high- and low-level interface to the \
    HDF5 library from Python. The low-level interface is intended to be a \
    complete wrapping of the HDF5 API, while the high-level component \
    supports  access to HDF5 files, datasets and groups using established \
    Python and NumPy concepts. \
    \n\nA strong emphasis on automatic conversion between Python (Numpy) \
    datatypes and data structures and their HDF5 equivalents vastly \
    simplifies the process of reading and writing data from Python.

homepage            http://www.h5py.org
master_sites        https://pypi.python.org/packages/source/h/h5py
distname            h5py-${version}

checksums \
    rmd160  94484badd1103c00421582a055b7b0f3368ad653 \
    sha256  9833df8a679e108b561670b245bcf9f3a827b10ccb3a5fa1341523852cfac2f6

# Support for -devel
set DEV_VERSION     0

subport             py26-h5py-devel {set DEV_VERSION 26}
subport             py27-h5py-devel {set DEV_VERSION 27}
subport             py33-h5py-devel {set DEV_VERSION 33}
subport             py34-h5py-devel {set DEV_VERSION 34}

python.versions     26 27 33 34 35

if {${DEV_VERSION}} {
    python.version      ${DEV_VERSION}
    # epoch was already set to a date; continuing with that approach
    epoch               20150122
    version             2.5.0
    conflicts           py${python.version}-h5py
    checksums \
        rmd160  94484badd1103c00421582a055b7b0f3368ad653 \
        sha256  9833df8a679e108b561670b245bcf9f3a827b10ccb3a5fa1341523852cfac2f6
} elseif {${name} ne ${subport}} {
    conflicts           py${python.version}-h5py-devel
}

python.default_version 27

if {${name} ne ${subport}} {
    depends_build-append    port:py${python.version}-cython

    depends_lib-append      port:py${python.version}-numpy \
                            port:py${python.version}-six \
                            port:py${python.version}-pkgconfig \
                            port:hdf5


    # TODO: set compiler appropriately to build against parallel HDF5 
    # (even when MPI variant not requested), ticket #45911
    #configure.cc mpicc
    #configure.cc h5pcc

    post-destroot {
        system -W ${destroot}${prefix} "mkdir -p share/doc/${subport}"
        copy ${worksrcpath}/lzf/LICENSE.txt \
            ${destroot}${prefix}/share/doc/${subport}
    }

    # Add MPI support
    mpi.setup
    if {[mpi_variant_isset]} {
        depends_lib-append  port:py${python.version}-mpi4py
        mpi.enforce_variant hdf5 \
                            py${python.version}-mpi4py

        use_configure   yes
        configure.cmd   ${build.cmd} configure
        configure.args  --mpi
        configure.pre_args
    }

    livecheck.type      none
} else {
    livecheck.type      regex
    livecheck.url       https://pypi.python.org/pypi/h5py
    livecheck.regex     {h5py/(\d+(?:\.\d+)*)}
}
