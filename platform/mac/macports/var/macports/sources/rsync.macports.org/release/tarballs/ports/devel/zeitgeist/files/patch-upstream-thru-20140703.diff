From b1e82de434a7b63fe1290d0051de58350b069991 Mon Sep 17 00:00:00 2001
From: Philip Withnall <philip@tecnocode.co.uk>
Date: Sun, 16 Feb 2014 15:08:49 +0000
Subject: libzeitgeist: Add a missing dependency on gio-2.0

This actually makes the zeitgeist vapi file usable.

Signed-off-by: Seif Lotfy <seif@lotfy.com>

diff --git a/libzeitgeist/zeitgeist-2.0.deps b/libzeitgeist/zeitgeist-2.0.deps
index ff8d39b..59eec5d 100644
--- libzeitgeist/zeitgeist-2.0.deps
+++ libzeitgeist/zeitgeist-2.0.deps
@@ -1 +1,2 @@
 zeitgeist-datamodel-2.0
+gio-2.0
-- 
cgit v0.10.2

From 3fe95cdb5a4c48d3b6606ffb1f60fae3e375fdff Mon Sep 17 00:00:00 2001
From: Seif Lotfy <seif@lotfy.com>
Date: Tue, 4 Mar 2014 20:55:53 +0100
Subject: Replace get_nprocs_conf with g_get_num_processors()


diff --git a/libzeitgeist/log.vala b/libzeitgeist/log.vala
index 02b16ca..f0b65cb 100644
--- libzeitgeist/log.vala
+++ libzeitgeist/log.vala
@@ -40,6 +40,7 @@
  * Zeitgeist also comes with a blacklist extension to make sure the user
  * always stays in control of what information is logged.
  */
+
 namespace Zeitgeist
 {
 
@@ -58,8 +59,8 @@ namespace Zeitgeist
  */
 public class Log : QueuedProxyWrapper
 {
-    [CCode (cheader_filename = "sys/sysinfo.h", cname = "get_nprocs_conf")]
-    extern static int get_nprocs_conf ();
+    [CCode (cname = "g_get_num_processors")]
+    private extern static uint get_num_processors ();
 
     class DbWorker
     {
@@ -141,7 +142,7 @@ public class Log : QueuedProxyWrapper
         try {
             threads = new ThreadPool<DbWorker>.with_owned_data ((worker) => {
                 worker.run ();
-            }, get_nprocs_conf (), true);
+            }, (int) get_num_processors (), true);
         } catch (ThreadError err) {
             warning ("%s", err.message);
             threads = null;
@@ -637,4 +638,3 @@ public class Log : QueuedProxyWrapper
 
 }
 
-// vim:expandtab:ts=4:sw=4
-- 
cgit v0.10.2

From 201bd67de450320520a12e2b0c465c8eb6818bd2 Mon Sep 17 00:00:00 2001
From: Rico Tzschichholz <ricotz@ubuntu.com>
Date: Mon, 17 Mar 2014 20:57:49 +0100
Subject: WhereClause: Fix array-length to work with string.joinv of vala-0.24


diff --git a/libzeitgeist/where-clause.vala b/libzeitgeist/where-clause.vala
index a830599..d981914 100644
--- libzeitgeist/where-clause.vala
+++ libzeitgeist/where-clause.vala
@@ -211,7 +211,11 @@ namespace Zeitgeist
          */
         private T[] generic_array_to_unowned_array<T> (GenericArray<T> gptrarr)
         {
+#if VALA_0_24
+            long[] pointers = new long[gptrarr.length];
+#else
             long[] pointers = new long[gptrarr.length + 1];
+#endif
             Memory.copy(pointers, ((PtrArray *) gptrarr)->pdata,
                 (gptrarr.length) * sizeof (void *));
             return (T[]) pointers;
-- 
cgit v0.10.2

From d2c966faf4979b5745ea0df8062795fc82b9fcc1 Mon Sep 17 00:00:00 2001
From: Rico Tzschichholz <ricotz@ubuntu.com>
Date: Mon, 17 Mar 2014 21:02:01 +0100
Subject: Require glib >= 2.35.4 according to the usage of
 g_get_num_processors()

Bump vala buildflags accordingly

diff --git a/configure.ac b/configure.ac
index acf7daa..45f50c7 100644
--- configure.ac
+++ configure.ac
@@ -29,7 +29,7 @@ AC_SUBST(CFLAGS)
 AC_SUBST(CPPFLAGS)
 AC_SUBST(LDFLAGS)
 
-GLIB_REQUIRED=2.26.0
+GLIB_REQUIRED=2.35.4
 SQLITE_REQUIRED=3.7.11
 VALADOC_REQUIRED=0.2
 
diff --git a/datahub/Makefile.am b/datahub/Makefile.am
index 9629baa..19bcb3b 100644
--- datahub/Makefile.am
+++ datahub/Makefile.am
@@ -10,7 +10,7 @@ AM_CPPFLAGS = \
 	$(NULL)
 
 AM_VALAFLAGS = \
-	--target-glib=2.26 \
+	--target-glib=2.36 \
 	--pkg gio-2.0 \
 	--pkg gio-unix-2.0 \
 	--pkg gtk+-3.0 \
diff --git a/examples/vala/Makefile.am b/examples/vala/Makefile.am
index 99584e6..b7cd7c2 100644
--- examples/vala/Makefile.am
+++ examples/vala/Makefile.am
@@ -8,7 +8,7 @@ AM_CPPFLAGS = \
 	$(NULL)
 
 AM_VALAFLAGS = \
-	--target-glib=2.26 \
+	--target-glib=2.36 \
 	--pkg gio-2.0 \
 	$(top_builddir)/libzeitgeist/zeitgeist-datamodel-2.0.vapi \
 	$(top_builddir)/libzeitgeist/zeitgeist-2.0.vapi \
diff --git a/extensions/Makefile.am b/extensions/Makefile.am
index 20139aa..72b9e24 100644
--- extensions/Makefile.am
+++ extensions/Makefile.am
@@ -24,7 +24,7 @@ AM_CPPFLAGS = \
 	$(NULL)
 
 AM_VALAFLAGS = \
-	--target-glib=2.26 \
+	--target-glib=2.36 \
 	--pkg gio-2.0 \
 	--pkg sqlite3 \
 	--pkg gmodule-2.0 \
diff --git a/extensions/fts++/Makefile.am b/extensions/fts++/Makefile.am
index 8bd9936..0ebf206 100644
--- extensions/fts++/Makefile.am
+++ extensions/fts++/Makefile.am
@@ -21,7 +21,7 @@ AM_CPPFLAGS = \
 	$(NULL)
 
 AM_VALAFLAGS = \
-	--target-glib=2.26 \
+	--target-glib=2.36 \
 	--pkg gio-2.0 \
 	--pkg sqlite3 \
 	--pkg posix \
diff --git a/libzeitgeist/Makefile.am b/libzeitgeist/Makefile.am
index f44e950..9af0cb4 100644
--- libzeitgeist/Makefile.am
+++ libzeitgeist/Makefile.am
@@ -27,7 +27,7 @@ AM_CPPFLAGS = \
 	$(NULL)
 
 AM_VALAFLAGS = \
-	--target-glib=2.26 \
+	--target-glib=2.36 \
 	--pkg gio-2.0 \
 	--pkg gio-unix-2.0 \
 	--pkg sqlite3 \
diff --git a/libzeitgeist/log.vala b/libzeitgeist/log.vala
index f0b65cb..3de1c7d 100644
--- libzeitgeist/log.vala
+++ libzeitgeist/log.vala
@@ -59,9 +59,6 @@ namespace Zeitgeist
  */
 public class Log : QueuedProxyWrapper
 {
-    [CCode (cname = "g_get_num_processors")]
-    private extern static uint get_num_processors ();
-
     class DbWorker
     {
         private unowned ThreadFunc<void*> func;
diff --git a/src/Makefile.am b/src/Makefile.am
index 3deb6c2..65751ef 100644
--- src/Makefile.am
+++ src/Makefile.am
@@ -11,7 +11,7 @@ AM_CPPFLAGS = \
 	$(NULL)
 
 AM_VALAFLAGS = \
-	--target-glib=2.26 \
+	--target-glib=2.36 \
 	--pkg gio-2.0 \
 	--pkg sqlite3 \
 	--pkg posix \
diff --git a/test/direct/Makefile.am b/test/direct/Makefile.am
index 80279d4..59e9f5f 100644
--- test/direct/Makefile.am
+++ test/direct/Makefile.am
@@ -8,7 +8,7 @@ EXTRA_DIST = \
 	$(NULL)
 
 AM_VALAFLAGS = \
-	--target-glib=2.26 \
+	--target-glib=2.36 \
 	--pkg gio-2.0 \
 	--pkg gio-unix-2.0 \
 	--pkg sqlite3 \
-- 
cgit v0.10.2

