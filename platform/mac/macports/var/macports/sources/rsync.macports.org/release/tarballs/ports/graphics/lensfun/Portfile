# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id: Portfile 139025 2015-07-30 05:04:52Z devans@macports.org $

PortSystem          1.0
PortGroup           cmake 1.0
PortGroup           compiler_blacklist_versions 1.0

cmake.out_of_source yes

name                lensfun
epoch               1
version             0.3.1
categories          graphics
platforms           darwin
maintainers         devans openmaintainer
license             GPL-3 LGPL-3 CC-BY-SA

description         Library for fixing lens geometry distortion

long_description    Provides a database of photographic lenses and a library \
                    that allows advanced access to the database including \
                    functions to correct images based on intimate knowledge \
                    of lens characteristics and calibration data.

homepage            http://lensfun.sourceforge.net/
master_sites        sourceforge:project/${name}/${version}

checksums           rmd160  b98aeed79c4514ed73ecd48e46d78c673b7d7e96 \
                    sha256  216c23754212e051c8b834437e46af3812533bd770c09714e8c06c9d91cdb535

# With 0.3.0 and gcc-4.2:
#    #error "I don't know how to change symbol visibility for your compiler"
compiler.blacklist-append *gcc* {clang < 100}

depends_build-append \
                    port:pkgconfig

depends_lib         path:lib/pkgconfig/glib-2.0.pc:glib2 \
                    port:libpng \
                    port:zlib

# installs python3 helper scripts lensfun-add-adapter lensfun-update-data

depends_run         port:python34

pre-patch {
    copy ${worksrcpath}/docs/CMakeLists.txt ${worksrcpath}/docs/CMakeLists.txt.orig
}

patchfiles          patch-docs-CMakeLists.txt.diff

post-patch {
                    reinplace "s|^#!.*|#!${prefix}/bin/python3.4|" \
                         ${worksrcpath}/apps/lensfun-add-adapter \
                         ${worksrcpath}/apps/lensfun-update-data
}

configure.args-append \
                    -DPYTHON_EXECUTABLE=${prefix}/bin/python3.4 \
                    -DBUILD_LENSTOOL=ON

variant doc description {Build API and man documentation using doxygen, rst2man} {
    depends_build-append \
                    port:doxygen \
                    port:py34-docutils

    configure.args-append \
                    -DBUILD_DOC=ON
}

livecheck.regex     "${name}-(\\d+(?:\\.\\d+)*)"
