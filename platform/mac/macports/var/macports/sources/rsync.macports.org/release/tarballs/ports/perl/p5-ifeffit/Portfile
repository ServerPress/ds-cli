# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id: Portfile 138659 2015-07-14 23:54:04Z devans@macports.org $

PortSystem          1.0
PortGroup           perl5 1.0

perl5.branches      5.16 5.18 5.20 5.22
perl5.setup         Ifeffit 2
epoch               1
version             1.2.13

platforms           darwin
license             Permissive
maintainers         nomaintainer

description         Perl interface to ifeffit

long_description    ${description}

homepage            http://cars9.uchicago.edu/ifeffit/
master_sites        https://github.com/newville/ifeffit/archive/

checksums           rmd160  dedd8b9f6be0d0b0bce67e5f53c18faddf7b0912 \
                    sha256  72a7f5bd6e6e1ff2b41761cfe726f79f2da8e71606399d3c3307451496a1c0ef

dist_subdir         ifeffit
distname            1.2.final
worksrcdir          ifeffit-${distname}/wrappers/perl

# IMPORTANT BUILD NOTES
#
# ifeffit, pgplot and p5-ifeffit need to be using the same compiler libraries.
# therefore they must be built with the same gcc compiler variants.
# currently this is gcc49 by default but it you change one change them all and rebuild.
#
# p5-ifeffit is configured using a Makefile.PL that is generated when ifeffit is built.
# since the paths to the compiler libraries contain compiler version information,
# if the compiler version changes then both ifeffit and p5-ifeffit need to be rebuilt
# so that the Makefile.PL in use contains the correct paths.
#
# if in doubt rebuild everything

variant gcc45 description {Use gfortran from gcc45} conflicts gcc46 gcc47 gcc48 gcc49 {}
variant gcc46 description {Use gfortran from gcc46} conflicts gcc45 gcc47 gcc48 gcc49 {}
variant gcc47 description {Use gfortran from gcc47} conflicts gcc45 gcc46 gcc48 gcc49 {}
variant gcc48 description {Use gfortran from gcc48} conflicts gcc45 gcc46 gcc47 gcc49 {}
variant gcc49 description {Use gfortran from gcc49} conflicts gcc45 gcc46 gcc47 gcc48 {}

if {![variant_isset gcc45] && ![variant_isset gcc46] && ![variant_isset gcc47] && ![variant_isset gcc48]} {
    default_variants +gcc49
}

if {${perl5.major} != ""} {
    depends_lib-append \
                    port:ifeffit

    foreach gcc {gcc45 gcc46 gcc47 gcc48 gcc49} {
        if {[variant_isset ${gcc}]} {
            # this is depends_lib so the correct gfortran library is available at both at build and run time
            depends_lib-append port:${gcc}
        }
    }

    pre-configure {
        # copy the preconfigured Makefile.PL generated during the build of ifeffit
        # this must be done in pre-configure to ensure that ifeffit is installed and active
        # before the copy is attempted
        
        copy -force ${prefix}/share/ifeffit/config/Makefile.PL ${worksrcpath}/Makefile.PL
    }
    
    post-configure {
        # Need to patch the generated Makefile due to strange bug
        reinplace "s|^PERL_ARCHIVE *= *$|PERL_ARCHIVE = \$(PERL_INC)/libperl.dylib|" ${worksrcpath}/Makefile
    }
}

# this is the final release of ifeffit
livecheck.type      none
