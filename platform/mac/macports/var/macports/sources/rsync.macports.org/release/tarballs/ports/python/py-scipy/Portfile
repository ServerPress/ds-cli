# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id: Portfile 131797 2015-01-18 20:29:16Z michaelld@macports.org $

PortSystem              1.0
PortGroup               python 1.0
PortGroup               active_variants 1.1
PortGroup               compilers 1.0

name                    py-scipy
version                 0.15.1
platforms               darwin
license                 BSD
maintainers             sean michaelld openmaintainer
description             An opensource library of scientific tools for Python
long_description        ${description}

homepage                http://www.scipy.org/
master_sites            sourceforge:project/scipy/scipy/${version}/
distname                scipy-${version}

checksums               rmd160  8c7a6468c0f796e0770d920d17829ea4e2cb89a9 \
                        sha256  a212cbc3b79e9a563aa45fc5c517b3499198bd7eb7e7be1e047568a5f48c259a

python.versions         26 27 33 34

python.add_archflags    no
universal_variant       no

compilers.setup         require_fortran -clang -dragonegg -gcc44 -gcc45 -gcc46 -g95

if {${name} ne ${subport}} {

    depends_lib-append      port:py${python.version}-numpy \
                            port:py${python.version}-nose \
                            port:swig-python

    worksrcdir              ${distname}

    build.env-append        CCFLAGS="-I${prefix}/include -L${prefix}/lib"
    destroot.env-append     CCFLAGS="-I${prefix}/include -L${prefix}/lib"
    configure.fflags-append -fno-second-underscore

    # https://trac.macports.org/ticket/46395
    # https://trac.macports.org/ticket/46428
    # https://github.com/scipy/scipy/issues/4383
    # remove this patch after next version update
    patch.pre_args          -p1
    patchfiles-append       patch-accelerate.diff

    post-patch {
        if {![variant_isset atlas] && [gcc_variant_isset]} {
            reinplace "s,#include <Accelerate/Accelerate.h>,#include <cblas.h>,g" \
                ${worksrcpath}/scipy/_build_utils/src/wrap_accelerate_c.c \
                ${worksrcpath}/scipy/_build_utils/src/wrap_g77_abi_c.c
        }
    }

    pre-configure {
        set fc_options      "config_fc --fcompiler gnu95 --f77exec ${configure.f77} --f77flags='${configure.f77_archflags} ${configure.fflags}' --f90exec ${configure.f90} --f90flags='${configure.f90_archflags} ${configure.fflags}'"
        set config_options  "config --cc ${configure.cc} --include-dirs ${prefix}/include --library-dirs ${prefix}/lib"
        build.cmd-append    ${fc_options} ${config_options}
        destroot.cmd-append ${fc_options} ${config_options}

        build.env-append    CC="${configure.cc}" \
                            CXX="${configure.cxx}" \
                            CFLAGS="${configure.cc_archflags}" \
                            CXXFLAGS="${configure.cxx_archflags}" \
                            CPPFLAGS="${configure.cppflags}"
        destroot.env-append CC="${configure.cc}" \
                            CXX="${configure.cxx}" \
                            CFLAGS="${configure.cc_archflags}" \
                            CXXFLAGS="${configure.cxx_archflags}" \
                            CPPFLAGS="${configure.cppflags}"
    }

    post-destroot {
        # for some reason read-world is not set
        system "chmod -R a+r ${destroot}${prefix}"
    }

    variant atlas description "Use MacPorts ATLAS libraries" {
        depends_lib-append  port:atlas

        require_active_variants port:py${python.version}-numpy atlas
    }

    if {[variant_isset atlas]} {
        build.env-append    ATLAS=${prefix}/lib \
                            LAPACK=${prefix}/lib \
                            BLAS=${prefix}/lib
        destroot.env-append ATLAS=${prefix}/lib \
                            LAPACK=${prefix}/lib \
                            BLAS=${prefix}/lib

        pre-fetch {
            # get the c compiler name, if blank set to clang which is what atlas
            # does
            set cc [c_variant_name]
            if {$cc eq ""} {
                set cc clang
            }

            # check the C compiler for atlas: if not the same then error out; we
            # don't need to check the fortran compiler because if atlas is compiled
            # with +clang then gcc48 (+gfortran in the compilers portgroup
            # language) is used for fortran. If a +gcc variant is used to compile
            # atlas, then that gcc's fortran is used so the c compiler check will
            # suffice.
            if {![catch {set result [active_variants atlas $cc ""]}]} {
                if {!$result} {
                    return -code error \
"You have selected the $cc compiler (either directly or indirectly) and the\
+atlas variant, which does not match the $cc compiler. Please ensure that both\
are compiled with the same one."
                }
            }

            # also check that numpy has the atlas variant active
            if {![catch {set result [active_variants py${python.version}-numpy atlas ""]}]} {
                if {!$result} {

                    return -code error \
"You have selected the +atlas variant but py${python.version}-numpy does not\
have the +atlas variant active. Please ensure that numpy is activated with the\
+atlas variant."
                }
            }

        }

    } else {
        build.env-append    ATLAS=None \
                            LAPACK=/usr/lib \
                            BLAS=/usr/lib
        destroot.env-append ATLAS=None \
                            LAPACK=/usr/lib \
                            BLAS=/usr/lib
    }

    livecheck.type          none
} else {
    livecheck.type          regex
    livecheck.url           http://sourceforge.net/projects/scipy/rss
    livecheck.regex         scipy-(\[0-9\.\]+)${extract.suffix}/download</guid>
}
