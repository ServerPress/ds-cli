# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:filetype=tcl:et:sw=4:ts=4:sts=4
# $Id: Portfile 140048 2015-09-08 02:04:10Z michaelld@macports.org $

PortSystem          1.0
PortGroup           github 1.0

name                gqrx
maintainers         michaelld openmaintainer

description         Gqrx is a software defined radio (SDR) receiver using GNU Radio, OSMOSDR, and Qt (4 or 5).

categories          science comms
license             GPL-3 BSD
platforms           darwin macosx

set description_common {Gqrx is a software defined radio receiver for Funcube Dongle (FCD), RTL2832U-based DVB-T devices (RTL-SDR), Universal Software Radio Peripherals (USRP) and Osmo SDR devices.  Gqrx is powered by GNU Radio and the Qt GUI toolkit.  Gqrx is free and open source software and anyone is invited to hack the source code to suit their needs.}

if {${subport} eq ${name}} {

    long_description    ${description}  \
        This port is kept up with the Gqrx GIT 'master' branch, is typically updated weekly to monthly, and provides compatibility with the GNU Radio release 3.7 API: the gnuradio and gnuradio-devel ports.  ${description_common}

    github.setup        csete gqrx 3a51618445ba4c5d10dea50e83ef7db04259d878
    version             20150906
    checksums           rmd160 d923f5f787bf79bd442473dd86de8a181a850e02 \
                        sha256 c25837960d4c1f07952b1ea644af58030561f7cab6e5f463541c19f849c7cafb

    conflicts           gqrx-legacy

    patchfiles-append   patch-gqrx.pro.diff

    # allow gqrx to work with both gnuradio and gnuradio-devel ...

    depends_lib-append  port:gr-osmosdr \
        path:lib/libgnuradio-audio.dylib:gnuradio

    # ... but not with gnuradio-legacy or gnuradio-next

    pre-fetch {
        if {![catch {set installed [lindex [registry_active gnuradio-legacy] 0]}]} {
            # gnuradio-legacy is installed; this version of gr-osmosdr does not work with gnuradio-legacy
            ui_msg "\nError: ${name} requires the gnuradio or gnuradio-devel port, and will not work with the gnuradio-legacy port.  deactivate gnuradio-legacy, and then install or activate gnuradio or gnuradio-devel.\n"
            return -code error "Invalid port dependency: gnuradio-legacy"
        }
        if {![catch {set installed [lindex [registry_active gnuradio-next] 0]}]} {
            # gnuradio-next is installed; this version of gr-osmosdr does not work with gnuradio-next
            ui_msg "\nError: ${name} requires the gnuradio or gnuradio-devel port, and will not work with the gnuradio-next port.  deactivate gnuradio-next, and then install or activate gnuradio or gnuradio-devel.\n"
            return -code error "Invalid port dependency: gnuradio-next"
        }
    }

    # this variant can be removed 2015-01-01
    variant portaudio description "Legacy variant" {}
}

subport gqrx-devel {

    # This port can be removed on December 4, 2015.

    replaced_by         gqrx
    PortGroup           obsolete 1.0

    name                gqrx-devel

    github.setup        csete gqrx 9648a148e04d0e5fc15b26151f44f8b10e8180e9
    version             20141127

    depends_lib
    depends_build
    depends_run

    patchfiles

    conflicts           gqrx-legacy

}

subport gqrx-legacy {

    long_description    ${description}  \
        This port is for the last Gqrx commit providing compatibility with GNU Radio release 3.6 API: the gnuradio-legacy port.  ${description_common}

    github.setup        csete gqrx 90ea4cfd685dffeac21cf1d860228f6eead1e4a5

    # fix port name set by github PortGroup

    name                gqrx-legacy

    version             2.0_20130703
    revision            3

    checksums           rmd160 eba005dfad221997a7d80a8d8cd132cfea209667 \
                        sha256 83403f9d2c05d10a8d8df76a4282c41b9d3547ceccaebecc92c1d3f0835a6f59

    conflicts           gqrx gqrx-devel

    # gqrx-legacy works with *-legacy only

    depends_lib-append  port:gnuradio-legacy \
                        port:gr-osmosdr-legacy

    patchfiles-append   patch-gqrx.pro-legacy.diff

    # patch to fix usage of real and imag to be compatible with both
    # libstdc++ and libc++ runtimes; this patch is included with the
    # release and devel from upstream.

    patchfiles-append   patch-fix-real-imag.diff

    # no version checking for now

    livecheck.type      none

}

# override githib PortGroup homepage setting

homepage            http://gqrx.dk/

if {${subport} ne "gqrx-devel"} {
    if {${subport} eq "gqrx"} {

        variant qt4 conflicts qt5 description {Build ${subport} using Qt4} {
            PortGroup qmake 1.0
        }

        variant qt5 conflicts qt4 description {Build ${subport} using Qt5} {

            PortGroup qmake5 1.0
            PortGroup active_variants 1.1

            # make sure gnuradio* is installed with -qtgui, because we
            # can't have Qt4 and Qt5 installed at the same time (yet),
            # and gnuradio* does not (yet) support Qt5.

            require_active_variants path:lib/libgnuradio-audio.dylib:gnuradio "" qtgui

        }

        # default to +qt4

        if {![variant_isset qt4] && ![variant_isset qt5]} {
            default_variants +qt4
        }

        # make sure -qt4 is not used alone

        if {![variant_isset qt4] && ![variant_isset qt5]} {

            ui_error "\n\nYou must select either the +qt4 or +qt5 variant.\n"
            return -code error "Invalid variant selection"

        }
    } else {

        # gqrx-legacy uses Qt4 only
        PortGroup qmake 1.0

    }

    post-patch {

        # set install location

        reinplace "s|@APPSDIR@|${qt_apps_dir}|g" ${worksrcpath}/gqrx.pro

        # set version

        reinplace "s|@VERSION@|${version}|g" ${worksrcpath}/gqrx.pro

        # set arch type(s)

        reinplace "s|@ARCHES@|${qt_arch_types}|g" ${worksrcpath}/gqrx.pro

    }

    configure.post_args gqrx.pro

    post-configure {

        # remove indirect dependency on Volk added by pkgconfig

        reinplace "s|-lvolk ||g" ${worksrcpath}/Makefile

    }

    post-destroot {

        # link the executable back to $qt_bins_dir, and, if $qt_dir is
        # not $prefix, back to $prefix/bin too.

        xinstall -m 755 -d ${destroot}${qt_bins_dir}
        ln -s ${qt_apps_dir}/Gqrx.app/Contents/MacOS/Gqrx \
            ${destroot}${qt_bins_dir}

        if {${qt_dir} ne ${prefix}} {
            xinstall -m 755 -d ${destroot}${prefix}/bin
            ln -s ${qt_apps_dir}/Gqrx.app/Contents/MacOS/Gqrx \
                ${destroot}${prefix}/bin
        }
    }
}
