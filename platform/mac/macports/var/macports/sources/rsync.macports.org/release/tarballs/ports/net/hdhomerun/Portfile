# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id: Portfile 139201 2015-08-06 19:25:54Z ctreleaven@macports.org $

PortSystem          1.0

name                hdhomerun
version             20150615
categories          net multimedia
platforms           darwin
supported_archs     i386 x86_64
license             LGPL-3+
maintainers         ctreleaven openmaintainer
description         HDHomeRun configuration utility
homepage            http://www.silicondust.com/

master_sites        http://download.silicondust.com/hdhomerun

if {${name} eq ${subport}} {
    set firm_version    20150604
    conflicts           ${name}-devel
    long_description    Provides a library and utility program to access, configure and test \
                        HDHomeRun network tuner devices from SiliconDust.  May also be used to \
                        upgrade firmware. Command line-driven and scriptable.

    distname            lib${name}_${version}
    extract.suffix      .tgz
    extract.only        ${distname}${extract.suffix}
    worksrcdir          lib${name}
    distfiles-append    ${name}_atsc_firmware_${firm_version}.bin \
                        ${name}_dvbt_firmware_${firm_version}.bin \
                        ${name}3_atsc_firmware_${firm_version}.bin \
                        ${name}3_dvbt_firmware_${firm_version}.bin \
                        ${name}3_dvbtc_firmware_${firm_version}.bin \
                        ${name}3_dvbc_firmware_${firm_version}.bin \
                        ${name}3_cablecard_firmware_${firm_version}.bin \
                        ${name}tc_atsc_firmware_${firm_version}.bin \
                        ${name}4_atsc_firmware_${firm_version}.bin
    checksums           libhdhomerun_20150615.tgz \
                        rmd160  fc459f2aadc0832f5699848ce5be9c7378baeb59 \
                        sha256  0f239f05868a7494764c05002aa6769193b8850dab93731c7bd9927c9074aad6 \
                        hdhomerun_atsc_firmware_20150604.bin \
                        rmd160  af2594974cf4a00f238220797e4e8086ad16eda7 \
                        sha256  737d8da48daaa1ef375f755a3bbc28ba6e232f47142bc4e2a160387bb89dd6f8 \
                        hdhomerun_dvbt_firmware_20150604.bin \
                        rmd160  4bf2f563c40c07f0b64fa037e16a4d55f8beb277 \
                        sha256  d611f0c124c5e5aa4d5a99f1fda181675efb6f84c6ebe958e2615d742b7aa785 \
                        hdhomerun3_atsc_firmware_20150604.bin \
                        rmd160  6045ae5e5d62c5edcac904594aa619c90d4a449c \
                        sha256  79926ace9a6526b4d29cbb4cd5c144dcb136eed97e8700f323a15d10c0a9d6c7 \
                        hdhomerun3_dvbt_firmware_20150604.bin \
                        rmd160  58785678b432b239725fc02685c11377afbdcb44 \
                        sha256  6d71626e6bf352e2f84400a59af39e3e59a323796e1a4efbe56dca6a9f55d953 \
                        hdhomerun3_dvbtc_firmware_20150604.bin \
                        rmd160  0ee2a6288fc67745227b889ff352329289d8c6b3 \
                        sha256  9f33df383de44df0a828f6c9912446baa0e8a4de16cc1d071e94fa45227e0605 \
                        hdhomerun3_dvbc_firmware_20150604.bin \
                        rmd160  df60e7149fe4fdd5a3ee55fe113bf7a0e21fb8b9 \
                        sha256  6110f077a7f8a1d6d380034b1f5d5e50bca66692772e257c549a4e2308fab7e8 \
                        hdhomerun3_cablecard_firmware_20150604.bin \
                        rmd160  46a82ed3887ff20307c832b0f8491ea13a3428fc \
                        sha256  859252c57f0abc22b12a96dca4cad4f50a725337d5afe55ac99d246f7e46258b \
                        hdhomeruntc_atsc_firmware_20150604.bin \
                        rmd160  725bd1662883a92475318098400a32a19e851574 \
                        sha256  180327997940512fe26f6697fe3d2b96ced3c454d0408992c2d71cd5ff9a9e2b \
                        hdhomerun4_atsc_firmware_20150604.bin \
                        rmd160  c98df1ed8f67c9e9d7f9e5e80aa3ddad908c3e7a \
                        sha256  83e71de5be64eb16ab37bd4ce57fad7a0b1702f874798d7f0dbb387801fa5c49

    patchfiles          patch-01-Makefile-libpath.diff patch-02-Makefile-universal.diff
    patch.args          -p1
    post-patch {
        reinplace "s|@PREFIX@|${prefix}|g" ${worksrcpath}/Makefile
    }

    use_configure       no
    
    build.args-append   CC=${configure.cc} \
                        CXX=${configure.cxx} \
                        CPP=${configure.cpp}
    if {[variant_isset universal]} {
        build.args-append   CFLAGS="${configure.universal_cflags}"
    } else {
        build.args-append   CFLAGS="${configure.cc_archflags}"
    }
    
    destroot {
        xinstall -m 0755 ${worksrcpath}/hdhomerun_config \
            ${destroot}${prefix}/bin/hdhomerun_config
        xinstall -m 0755 ${worksrcpath}/libhdhomerun.dylib \
            ${destroot}${prefix}/lib/libhdhomerun.dylib
        xinstall -m 0644 -W ${worksrcpath} \
                hdhomerun.h hdhomerun_os.h hdhomerun_os_posix.h \
                hdhomerun_types.h hdhomerun_pkt.h hdhomerun_sock.h \
                hdhomerun_debug.h hdhomerun_discover.h hdhomerun_control.h \
                hdhomerun_video.h hdhomerun_channels.h hdhomerun_channelscan.h \
                hdhomerun_device.h hdhomerun_device_selector.h \
            ${destroot}${prefix}/include/
        xinstall -d -m 0755 ${destroot}${prefix}/share/${name}/
        foreach firm [glob ${distpath}/${name}*firmware_${firm_version}.bin] {
            set firm [lindex [split ${firm} /] end]
            xinstall -m 0644 ${distpath}/${firm} ${destroot}${prefix}/share/${name}/${firm}
        }
        xinstall -d -m 0755 ${destroot}${prefix}/share/doc/${name}/
        xinstall -m 0644 ${worksrcpath}/README \
            ${destroot}${prefix}/share/doc/${name}/README
    }
    livecheck.type      regex
    livecheck.url       http://www.silicondust.com/support/hdhomerun/downloads/
    livecheck.regex     Current release: (\[0-9\]+)
}

subport ${name}-devel {
    replaced_by         hdhomerun
    PortGroup           obsolete 1.0
    
    version             20150319beta1
    set firm_version    20150323beta2

}

notes   "
Documentation available at: http://www.silicondust.com/hdhomerun/hdhomerun_development.pdf
To upgrade device to newest firmware run:
    hdhomerun_config <id> upgrade ${prefix}/share/${name}/<firmware>
Choose the correct <firmware> based on your model of HDHomerun device:
HDHR-US (hdhomerun_atsc_firmware_${firm_version}.bin)
HDHR-EU (hdhomerun_dvbt_firmware_${firm_version}.bin)
HDHR3-US (hdhomerun3_atsc_firmware_${firm_version}.bin)
HDHR3-DT (hdhomerun3_dvbt_firmware_${firm_version}.bin)
HDHR3-EU (hdhomerun3_dvbtc_firmware_${firm_version}.bin)
HDHR3-CC (hdhomerun3_cablecard_firmware_${firm_version}.bin)
HDHR3-4DC (hdhomerun3_dvbc_firmware_${firm_version}.bin)
HDTC-2US (hdhomeruntc_atsc_firmware_${firm_version}.bin)
HDHR4-2US (hdhomrun4_atsc_firmware_${firm_version}.bin)
"
