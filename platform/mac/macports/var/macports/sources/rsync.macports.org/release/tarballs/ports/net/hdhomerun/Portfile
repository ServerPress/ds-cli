# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id: Portfile 134444 2015-03-25 18:41:45Z ctreleaven@macports.org $

PortSystem          1.0

name                hdhomerun
version             20141210
revision            1
categories          net multimedia
platforms           darwin
supported_archs     i386 x86_64
license             LGPL-3+
maintainers         ctreleaven openmaintainer
description         HDHomeRun configuration utility
long_description    Provides a library and utility program to access, configure and test \
                    HDHomeRun network tuner devices from SiliconDust.  May also be used to \
                    upgrade firmware. Command line-driven and scriptable.
homepage            http://www.silicondust.com/

master_sites        http://download.silicondust.com/hdhomerun
patchfiles          patch-01-Makefile-libpath.diff patch-02-Makefile-universal.diff
patch.args          -p1
extract.suffix      .tgz

if {${name} eq ${subport}} {
    set firm_version    20141124
    conflicts           ${name}-devel

    distname            lib${name}_${version}
    distfiles-append    ${name}_atsc_firmware_${firm_version}.bin \
                        ${name}_dvbt_firmware_${firm_version}.bin \
                        ${name}3_atsc_firmware_${firm_version}.bin \
                        ${name}3_dvbt_firmware_${firm_version}.bin \
                        ${name}3_dvbtc_firmware_${firm_version}.bin \
                        ${name}3_dvbc_firmware_${firm_version}.bin \
                        ${name}3_cablecard_firmware_${firm_version}.bin \
                        ${name}tc_atsc_firmware_${firm_version}.bin \
                        ${name}4_atsc_firmware_${firm_version}.bin
    checksums           libhdhomerun_20141210.tgz \
                        rmd160  e1f72c85ea1288bb6f31c79dbcae9dbbb417f5f0 \
                        sha256  27ab0a818883418c4f11fbae00334eb7187e39b5ea97dc0b28ea0a84dbeb7bb9 \
                        hdhomerun_atsc_firmware_20141124.bin \
                        rmd160  89025f746bcaf9c31c616d86356921c0256f216c \
                        sha256  e4b029a4cb6f64aa9c6d3c904119f207798104a991de664a342b7f9b5ed3dbd1 \
                        hdhomerun_dvbt_firmware_20141124.bin \
                        rmd160  739f9c475918fa04e44f5d5627e368c5c0faaf0d \
                        sha256  fbe64d8596e7fa05ae98f3afe44d777c88fd2f428e48466cbfd9bbfd12d362a4 \
                        hdhomerun3_atsc_firmware_20141124.bin \
                        rmd160  afc3882581cdd73affa893de5a35a4544f77661d \
                        sha256  a312d763f0ea298fe39c657cc5729060f90c929154e9e8ac1ac033b1a96f6157 \
                        hdhomerun3_dvbt_firmware_20141124.bin \
                        rmd160  de9262ae25fc001789b1dbf2160e4d5ee9726627 \
                        sha256  54853fbbb4c9a5a1adfc2c6ac552c6428161a19cee4e7ff82ecd5d4f64d0fa30 \
                        hdhomerun3_dvbtc_firmware_20141124.bin \
                        rmd160  7ff5aa2b8c7bb32a65ca423beaeb1637163452f3 \
                        sha256  7e8758548e620f17dffb612babadd2cc06f8fbd72e2abb0c58e16fdaf3e964b9 \
                        hdhomerun3_dvbc_firmware_20141124.bin \
                        rmd160  dd3474649c9c636df7a0baa0c1e4599f52fbd9a0 \
                        sha256  002ee6bf5738791d2d9f84f80b7b44a29c26b3385f2af2d6e06495a7b6cb29c6 \
                        hdhomerun3_cablecard_firmware_20141124.bin \
                        rmd160  6c477ff4d06dd2473356a238099222dc9854f151 \
                        sha256  f39772e230a251cf19985c5e213eb92653b0af986587fbbef6e8f743ccc463b5 \
                        hdhomeruntc_atsc_firmware_20141124.bin \
                        rmd160  a8cc66c8d42113b9078b6d2f1ef2c65da8f7b645 \
                        sha256  5a85059298efad7d6c49199737c4f19e9c5fd637288145027be0db800b91a226 \
                        hdhomerun4_atsc_firmware_20141124.bin \
                        rmd160  fdd78a4ff762c1aa69d19cd01846f6e106da8082 \
                        sha256  16902d63acef6e283660e5b6fb5fbbbbcecab80671dfbcabf11bbe7bc9a20765
}

subport ${name}-devel {
    version             20150319beta1
    set firm_version    20150323beta2
    conflicts           ${name}

    distname            lib${name}_${version}
    distfiles-append    ${name}_atsc_firmware_${firm_version}.bin \
                        ${name}_dvbt_firmware_${firm_version}.bin \
                        ${name}3_atsc_firmware_${firm_version}.bin \
                        ${name}3_dvbt_firmware_${firm_version}.bin \
                        ${name}3_dvbtc_firmware_${firm_version}.bin \
                        ${name}3_dvbc_firmware_${firm_version}.bin \
                        ${name}3_cablecard_firmware_${firm_version}.bin \
                        ${name}tc_atsc_firmware_${firm_version}.bin \
                        ${name}4_atsc_firmware_${firm_version}.bin
    checksums           libhdhomerun_20150319beta1.tgz \
                        rmd160  4c70de1b6266edc742736598bc07922eb3d4f103 \
                        sha256  ee4d535813f4028c60cb81a830df8a796faae2a74afc782faaebffc003a60583 \
                        hdhomerun_atsc_firmware_20150323beta2.bin \
                        rmd160  017ecd3094a4c434a982e299478ce286c423576e \
                        sha256  48035628549832c78ce9e4267b46f20a52af73d283f0df9b9d1072ff9448a67a \
                        hdhomerun_dvbt_firmware_20150323beta2.bin \
                        rmd160  b98e9010507d197ab7c3f04c2b7654d19813576c \
                        sha256  c1c92dc09b13a2d66af7df0fb464451daa0405333b6ae8665488dd6747b5db7d \
                        hdhomerun3_atsc_firmware_20150323beta2.bin \
                        rmd160  8629a2f6ac92433e0b05a95f7265b92321612927 \
                        sha256  0465e55d10c3f377e02af3a44ee816cfe78fbc4c2befabe60885ca3a22d3fd9a \
                        hdhomerun3_dvbt_firmware_20150323beta2.bin \
                        rmd160  66c69c852055a264dd711a206d1dd4edfdad0820 \
                        sha256  f1f3da4d007cfc7ec14b23a509f6c9b9a64ac43d0dfbb4a0596280435bbc2b59 \
                        hdhomerun3_dvbtc_firmware_20150323beta2.bin \
                        rmd160  7a97498c88df23553214d90abe6f42e6568c1b3d \
                        sha256  d2455b54bb7580aa15f0acd762b704b169287487707f1f208520b8e713402efe \
                        hdhomerun3_dvbc_firmware_20150323beta2.bin \
                        rmd160  637c27cde159f7607ffca80ebe0517da2addf460 \
                        sha256  34fd371ea031ad12402dc0b41c3e8d8895806bbb46c2af8ccdaf1242e579af42 \
                        hdhomerun3_cablecard_firmware_20150323beta2.bin \
                        rmd160  1e286beb7c3353b233ed257bf71e932d8c001f4b \
                        sha256  abfd432fea111d270a4353736d37c1dc417b6ff430961b5ba7680f64568e519e \
                        hdhomeruntc_atsc_firmware_20150323beta2.bin \
                        rmd160  55de9eea58a04417517deaa8f2621ee875324567 \
                        sha256  7b9e7b7664fc7e23b9d8778fb2c4a047ff9bb5c46f3dc327b6d30ea3a2c3c638 \
                        hdhomerun4_atsc_firmware_20150323beta2.bin \
                        rmd160  74b7410559ee6a4a8746c56f877c3dfe0ba25690 \
                        sha256  ee005957827dc9b257c87ff7f7834a68fc4b2da45aeb7dffbb4f42c9cedfc410
}

extract.only        ${distname}${extract.suffix}
worksrcdir          lib${name}

livecheck.type      regex
livecheck.url       http://www.silicondust.com/support/hdhomerun/downloads/
livecheck.regex     Current release: (\[0-9\]+)

use_configure       no

post-patch {
    reinplace "s|@PREFIX@|${prefix}|g" ${worksrcpath}/Makefile
}

build.args-append   CC=${configure.cc} \
                    CXX=${configure.cxx} \
                    CPP=${configure.cpp}
if {[variant_isset universal]} {
    build.args-append   CFLAGS="${configure.universal_cflags}"
} else {
    build.args-append   CFLAGS="${configure.cc_archflags}"
}

destroot {
    xinstall -m 0755 ${worksrcpath}/hdhomerun_config \
        ${destroot}${prefix}/bin/hdhomerun_config
    xinstall -m 0755 ${worksrcpath}/libhdhomerun.dylib \
        ${destroot}${prefix}/lib/libhdhomerun.dylib
    xinstall -m 0644 -W ${worksrcpath} \
            hdhomerun.h hdhomerun_os.h hdhomerun_os_posix.h \
            hdhomerun_types.h hdhomerun_pkt.h hdhomerun_sock.h \
            hdhomerun_debug.h hdhomerun_discover.h hdhomerun_control.h \
            hdhomerun_video.h hdhomerun_channels.h hdhomerun_channelscan.h \
            hdhomerun_device.h hdhomerun_device_selector.h \
        ${destroot}${prefix}/include/
    xinstall -d -m 0755 ${destroot}${prefix}/share/${name}/
    foreach firm [glob ${distpath}/${name}*firmware_${firm_version}.bin] {
        set firm [lindex [split ${firm} /] end]
        xinstall -m 0644 ${distpath}/${firm} ${destroot}${prefix}/share/${name}/${firm}
    }
    xinstall -d -m 0755 ${destroot}${prefix}/share/doc/${name}/
    xinstall -m 0644 ${worksrcpath}/README \
        ${destroot}${prefix}/share/doc/${name}/README
}

notes   "
Documentation available at: http://www.silicondust.com/hdhomerun/hdhomerun_development.pdf
To upgrade device to newest firmware run:
    hdhomerun_config <id> upgrade ${prefix}/share/${name}/<firmware>
Choose the correct <firmware> based on your model of HDHomerun device:
HDHR-US (hdhomerun_atsc_firmware_${firm_version}.bin)
HDHR-EU (hdhomerun_dvbt_firmware_${firm_version}.bin)
HDHR3-US (hdhomerun3_atsc_firmware_${firm_version}.bin)
HDHR3-DT (hdhomerun3_dvbt_firmware_${firm_version}.bin)
HDHR3-EU (hdhomerun3_dvbtc_firmware_${firm_version}.bin)
HDHR3-CC (hdhomerun3_cablecard_firmware_${firm_version}.bin)
HDHR3-4DC (hdhomerun3_dvbc_firmware_${firm_version}.bin)
HDTC-2US (hdhomeruntc_atsc_firmware_${firm_version}.bin)
HDHR4-2US (hdhomrun4_atsc_firmware_${firm_version}.bin)
"
