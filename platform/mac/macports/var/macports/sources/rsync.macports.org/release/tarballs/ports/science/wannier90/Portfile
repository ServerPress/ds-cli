# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id: Portfile 130949 2015-01-04 06:00:49Z sean@macports.org $

PortSystem          1.0
PortGroup           compilers 1.0

name                wannier90
version             2.0.0
categories          science
platforms           darwin
license             GPL-2+
maintainers         dstrubbe

description         A Tool for Obtaining Maximally-Localised Wannier Functions

long_description    Wannier90 uses inputs from an electronic-structure code \
                    to transform the Bloch orbitals of a crystal into \
                    maximally-localised Wannier functions. Interfaces exist \
                    for various density-functional theory codes.

homepage            http://www.wannier.org/
master_sites        ${homepage}code/

checksums           rmd160  58a58f75fd9ebb08965f7c87dd9fdb90dbaa20fc \
                    sha1    1d257c542327cdcf7481450170fb5887a90673a0

# TODO: enable use of Accelerate instead (will need f2c or veclibfort)
depends_lib         port:atlas

# fixes dependencies to enable parallel build
patchfiles          patch-utility-w90pov-Makefile.diff

configure {
    file copy ${worksrcpath}/config/make.sys.macosx ${worksrcpath}/make.sys
}

# TODO: enable use of MPI
pre-build {
    build.args      F90=${configure.f90} FCOPTS="-O3" LDOPTS="-O3" COMMS="" MPIF90=""
    if {[variant_isset threads]} {
        build.args-append LIBS="-L${prefix}/lib -ltatlas"
    } else {
        build.args-append LIBS="-L${prefix}/lib -lsatlas"
    }
    build.target    all w90pov w90vdw
}

use_parallel_build  yes

destroot {
    xinstall ${worksrcpath}/wannier90.x              ${destroot}${prefix}/bin/
    xinstall ${worksrcpath}/postw90.x                ${destroot}${prefix}/bin/
    xinstall ${worksrcpath}/w90chk2chk.x             ${destroot}${prefix}/bin/
    xinstall ${worksrcpath}/utility/w90pov/w90pov    ${destroot}${prefix}/bin/
    xinstall ${worksrcpath}/utility/w90vdw/w90vdw.x  ${destroot}${prefix}/bin/
    xinstall ${worksrcpath}/libwannier.a             ${destroot}${prefix}/lib/
}

compilers.choose    f90
compilers.setup     require_fortran

variant threads description {Build with threaded ATLAS} {}

test.run    yes
post-test {
    ui_notice "Examine the file ${worksrcpath}/tests/wantest.log."
}

livecheck.type      regex
livecheck.url       [lindex ${master_sites} 0]
livecheck.regex     ${name}-(\[0-9.\]+)${extract.suffix}
