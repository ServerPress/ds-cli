From 297eec69dc89073213afdb29cccfa68ea63428dd Mon Sep 17 00:00:00 2001
From: Jeremy Huddleston Sequoia <jeremyhu@apple.com>
Date: Sun, 11 Jan 2015 19:24:43 -0800
Subject: [PATCH 6/8] libunwind: Only include <Availability.h> on Leopard and
 newer OS X versions

http://www.llvm.org/bugs/show_bug.cgi?id=22203

Signed-off-by: Jeremy Huddleston Sequoia <jeremyhu@apple.com>
---
 include/libunwind.h | 22 ++++++++++++++++++----
 src/Unwind/config.h |  9 ++++++++-
 2 files changed, 26 insertions(+), 5 deletions(-)

diff --git a/include/libunwind.h b/include/libunwind.h
index 448d86a..a5630a5 100644
--- a/include/libunwind.h
+++ b/include/libunwind.h
@@ -26,12 +26,26 @@
 #endif
 
 #if __APPLE__
-  #include <Availability.h>
-    #if __arm__
-       #define LIBUNWIND_AVAIL __attribute__((unavailable))
+  #if __clang__
+    #if __has_include(<Availability.h>)
+      #include <Availability.h>
+    #endif
+  #elif __ENVIRONMENT_MAC_OS_X_VERSION_MIN_REQUIRED__ >= 1050
+    #include <Availability.h>
+  #endif
+
+  #if __arm__
+     #define LIBUNWIND_AVAIL __attribute__((unavailable))
+  #elif defined(__OSX_AVAILABLE_STARTING)
+    #define LIBUNWIND_AVAIL __OSX_AVAILABLE_STARTING(__MAC_10_6, __IPHONE_5_0)
+  #else
+    #include <AvailabilityMacros.h>
+    #ifdef AVAILABLE_MAC_OS_X_VERSION_10_6_AND_LATER
+      #define LIBUNWIND_AVAIL AVAILABLE_MAC_OS_X_VERSION_10_6_AND_LATER
     #else
-      #define LIBUNWIND_AVAIL __OSX_AVAILABLE_STARTING(__MAC_10_6, __IPHONE_5_0)
+      #define LIBUNWIND_AVAIL __attribute__((unavailable))
     #endif
+  #endif
 #else
   #define LIBUNWIND_AVAIL
 #endif
diff --git a/src/Unwind/config.h b/src/Unwind/config.h
index 80c476c..5f5c4fb 100644
--- a/src/Unwind/config.h
+++ b/src/Unwind/config.h
@@ -29,7 +29,14 @@
 
 // Platform specific configuration defines.
 #if __APPLE__
-  #include <Availability.h>
+  #if __clang__
+    #if __has_include(<Availability.h>)
+      #include <Availability.h>
+    #endif
+  #elif __ENVIRONMENT_MAC_OS_X_VERSION_MIN_REQUIRED__ >= 1050
+    #include <Availability.h>
+  #endif
+
   #ifdef __cplusplus
     extern "C" {
   #endif
-- 
2.2.1

